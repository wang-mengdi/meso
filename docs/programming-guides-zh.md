# 编程规范

## 工作流程
- 原则上任何可以测试的代码都应该写一个测试，例如`_tests_reservoir`和`_tests_solver_dec`中的那样。测试应该有一个确定的“通过/不通过”标准（设想ACM竞赛当中的Accepted/Wrong Answer），通过用`Pass()`函数输出，失败用`Error()`函数输出，**不应依赖用户的主观判断** （例如，不应让用户肉眼检查两个数组是否相等，而应该用`ArrayFunc::Is_Approx`接口）。

## 结构设计

- 代码库中所有内容均位于`namespace Meso`下。
- 一律采用`#pragma once`，不再使用`SimpleX`的macro guard方案.
- 遵循`README.md`中的文件结构，把代码文件放在合适的目录下。如确有需要，可在讨论后创建新目录。
- 目前暂时将代码库设计为header-only，**不在`.cpp`或`.cu`中实例化模板类** ，因当前阶段整个代码库仍然会频繁变动，这么做可以降低编译开销。后续做法再行讨论。
- 函数和类的区分标准：如果一个功能可能是若干与之并列的姐妹功能当中的一种，可能会被模块化替换（注：只需要认为有可能，当前代码中不需要存在），则**优先将其设计为一个类** 。例如`SemiLagrangian`应当是一个类，因为虽然它只有静态成员函数，但可以预想到，将来可能会存在与之并列的多种对流格式，这样写成类的方式，便于用模板的方法进行传输。而如果这个功能独特到不可能有与之并列的姐妹功能，则**优先将其设计为一个外接函数** （例如，`GridEulerFunc.h`里面的功能均为函数，以及`Marching_Cubes`为一个函数）。
- 在上一条的基础上，我们鼓励用“外包函数”的方法实现非核心功能。这样做的好处包括：(A)避免各个类变得过分冗长，(B)避免类之间产生复杂的依赖关系或循环依赖，(C)促使开发者在实现某个接口时思考其最小实现，而非默认一切都是可用的。例如，`PoissonFunc.h`中实现了“生成Poisson变换对应的稀疏矩阵”这样的功能，主要为了(A)(B)。而`IOFunc.h`当中实现了各种数据结构的输出功能，主要为了(B)(C).注意在这个关系当中，外包函数严格位于它所服务的类的下游，而不是反之。
- 各种主要的类均应放在一个名称与之相同或一致的`.h`当中。例如`Grid.h`实现`Grid`类，`PoissonMapping.h`实现`MaskedPoissonMapping`类。上述的“外包函数”应当放在某个`xxxFunc.h`中，例如`AuxFunc.h`，`PoissonFunc.h`.此时，应创建一个包含这种“外包函数”的namespace，例如`namespace IOFunc`，这样可以让代码更加清晰.
- 应尽量减少对类成员的穿透访问，但不必过分拘泥。


## 功能实现
- **原则上禁止使用宏实现功能。** 若有绝对设计必要可例外，例如`Points.h`当中，为了实现一行命令定义和注册变量，不得不用了宏，但仅用了一处。一般而言，
- **不鼓励特化模板类。** 例如，若某一函数在`d==2`和`d==3`时表现不同，推荐的做法是用类似`if constexpr (d==2)`区分两种实现，而不是定义这个函数对`d==2`和`d==3`的两种特化模板。
- **一切默认行为均为深拷贝** ，仅在完全明确的情况下提供无歧义的浅拷贝接口。
- **代码中原则上不出现裸指针（例如`int *`），亦不鼓励出现智能指针（`std::shared_ptr`）** ，但特殊情况除外（例如内核函数传数组）。特别地，Grid被专门设计为可以通过值拷贝传入内核函数，因此鼓励向内核函数里传入`const Grid<d>`，搭配一个`const T*`就相当于传入了一个`FieldDv<T,d>`的全部数据。
- 我们鼓励采用“基础裸接口+适配器”的方法实现功能。例如`Advection.h`当中，`Semi_Lagrangian_Cell()`函数实现主要功能，`SemiLagrangian`类负责给这个函数装配

## 标识符规则
- 类用首字母大写，无下划线，如`FaceField`.
- 函数用首字母大写+下划线，如`Face_Center()`.
- enum关键字全大写，但enum类型名应当遵循类的命名规则，如`DataHolder DEVICE`.

## 模板命名规则

- C++内建数据类型（如int、float、double）、Eigen当中有数学含义的基本数据类型（如四元数、复数）、Eigen中确定维数且维数较小的向量、矩阵（例如Vector2i, Matrix3），被视为Meso的内建数据类型，在模板编程中可以用`T`指代。

